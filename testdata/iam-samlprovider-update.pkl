/*
 * Â© 2025 Platform Engineering Labs Inc.
 *
 * SPDX-License-Identifier: FSL-1.1-ALv2
 */

amends "@formae/forma.pkl"
import "@formae/formae.pkl"

import "@aws/aws.pkl"

import "@aws/iam/samlprovider.pkl"

local testRunID = read("env:FORMAE_TEST_RUN_ID")
local stackName = "plugin-sdk-test-iam-samlprovider-\(testRunID)"

// Updated SAML metadata with different entity ID (no leading whitespace - AWS parser is strict)
local samlMetadata = #"""
<EntityDescriptor xmlns="urn:oasis:names:tc:SAML:2.0:metadata" entityID="https://sdk-test-updated.example.com/saml">
  <IDPSSODescriptor WantAuthnRequestsSigned="false" protocolSupportEnumeration="urn:oasis:names:tc:SAML:2.0:protocol">
    <KeyDescriptor use="signing">
      <KeyInfo xmlns="http://www.w3.org/2000/09/xmldsig#">
        <X509Data>
          <X509Certificate>MIIDHzCCAgegAwIBAgIUEYYL8uuyJppdeAXgFfRC1UQoRCowDQYJKoZIhvcNAQELBQAwHzEdMBsGA1UEAwwUc2RrLXRlc3QuZXhhbXBsZS5jb20wHhcNMjYwMjA4MDgxNjE0WhcNMzYwMjA2MDgxNjE0WjAfMR0wGwYDVQQDDBRzZGstdGVzdC5leGFtcGxlLmNvbTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAKYIjNMdiE/+eAYwDlIPAEhIl+/yZPtqkC0j79Cuj4GUcni8YohnrZUM4S/8xr8SMJw4S38GupxBYfhbYqBPD4fm+TdqzCTZiRRKNKzrc9jV9qoIc0uWwHNDDlWAmtzrsMBpR7NeYXFYYGRdyhLgVQseAcl6KZvcR5o4kd4wAmb2Ge5NtK7lXFrX2shmXpJVx0DQXWPbKpN02SnGwnjwkaJCeURRy18HHt/6JPBrJeNFNWf5QMXC1dnWVa3gNQsYhkrA71oxf7vneMOCepTAEf5r9xns2YJlHQkKLusQkEA+CGVnS1ZkAoHL/yCYN7EpRDYuvxaCGsIdarb694f8q3cCAwEAAaNTMFEwHQYDVR0OBBYEFEHLLKTy8GP5SD+CaBrlKa9anKsUMB8GA1UdIwQYMBaAFEHLLKTy8GP5SD+CaBrlKa9anKsUMA8GA1UdEwEB/wQFMAMBAf8wDQYJKoZIhvcNAQELBQADggEBAGyTFY4uH10Iv18e8GemDnb0VOSqD87wqlJdGPSl+/ECNobcg678MsHzyynk77+ZpigIhFgTI6IAKHQsl75asgPsxQojs/EEgNz8Jh61CK40ka6JC1mgcMvgoKVrJ3lv8DShF6XwjHaJHgjWLTt5WGcSfbixaq3r5Io5phQGMPzobOjUO+S/oQqREnGiYeIO1Tunw21+oOA+yPf7VXS5BUedJKpO4v+AOrra1OdOxFRYn5xIj31pC0s45wV+3Px5IiNSi+0CUM0ngcBkwhlkbHpuZ1ExiNSbp9m3cfk0e322DhwbvZR3av1KTuf6B+/y1o1sFvUagNtaji2U3c4pTDI=</X509Certificate>
        </X509Data>
      </KeyInfo>
    </KeyDescriptor>
    <SingleSignOnService Binding="urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect" Location="https://sdk-test-updated.example.com/saml/sso"/>
  </IDPSSODescriptor>
</EntityDescriptor>
"""#

forma {
  new formae.Stack {
    label = stackName
    description = "Plugin SDK test for IAM SAMLProvider"
  }

  new formae.Target {
    label = "aws-target"
    config = new aws.Config {
      region = "us-east-1"
    }
  }

  new samlprovider.SAMLProvider {
    label = "plugin-sdk-test-samlprovider"
    name = "formae-plugin-sdk-test-saml-\(testRunID)"
    samlMetadataDocument = samlMetadata
    tags {
      new { key = "Environment"; value = "updated" }
    }
  }
}
