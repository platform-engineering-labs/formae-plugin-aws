/*
 * Â© 2025 Platform Engineering Labs Inc.
 *
 * SPDX-License-Identifier: FSL-1.1-ALv2
 */

module aws.sagemaker.domain

import "@formae/formae.pkl"
import "../aws.pkl"

const type = "AWS::SageMaker::Domain"

typealias AppNetworkAccessType = "PublicInternetOnly"|"VpcOnly"
typealias AppSecurityGroupManagement = "Service"|"Customer"
typealias AuthMode = "SSO"|"IAM"
typealias DockerSettingsEnableDockerAccess = "ENABLED"|"DISABLED"
typealias ExecutionRoleIdentityConfig = "USER_PROFILE_NAME"|"DISABLED"

typealias InstanceType = "system"|"ml.t3.micro"|"ml.t3.small"|"ml.t3.medium"|"ml.t3.large"|"ml.t3.xlarge"|"ml.t3.2xlarge"|"ml.m5.large"|"ml.m5.xlarge"|"ml.m5.2xlarge"|"ml.m5.4xlarge"|"ml.m5.8xlarge"|"ml.m5.12xlarge"|"ml.m5.16xlarge"|"ml.m5.24xlarge"|"ml.c5.large"|"ml.c5.xlarge"|"ml.c5.2xlarge"|"ml.c5.4xlarge"|"ml.c5.9xlarge"|"ml.c5.12xlarge"|"ml.c5.18xlarge"|"ml.c5.24xlarge"|"ml.p3.2xlarge"|"ml.p3.8xlarge"|"ml.p3.16xlarge"|"ml.g4dn.xlarge"|"ml.g4dn.2xlarge"|"ml.g4dn.4xlarge"|"ml.g4dn.8xlarge"|"ml.g4dn.12xlarge"|"ml.g4dn.16xlarge"|"ml.r5.large"|"ml.r5.xlarge"|"ml.r5.2xlarge"|"ml.r5.4xlarge"|"ml.r5.8xlarge"|"ml.r5.12xlarge"|"ml.r5.16xlarge"|"ml.r5.24xlarge"|"ml.p3dn.24xlarge"|"ml.m5d.large"|"ml.m5d.xlarge"|"ml.m5d.2xlarge"|"ml.m5d.4xlarge"|"ml.m5d.8xlarge"|"ml.m5d.12xlarge"|"ml.m5d.16xlarge"|"ml.m5d.24xlarge"|"ml.g5.xlarge"|"ml.g5.2xlarge"|"ml.g5.4xlarge"|"ml.g5.8xlarge"|"ml.g5.12xlarge"|"ml.g5.16xlarge"|"ml.g5.24xlarge"|"ml.g5.48xlarge"|"ml.p4d.24xlarge"|"ml.p4de.24xlarge"|"ml.geospatial.interactive"|"ml.trn1.2xlarge"|"ml.trn1.32xlarge"|"ml.trn1n.32xlarge"
typealias RStudioServerProAppSettingsAccessStatus = "ENABLED"|"DISABLED"
typealias RStudioServerProAppSettingsUserGroup = "R_STUDIO_ADMIN"|"R_STUDIO_USER"
typealias SharingSettingsNotebookOutputOption = "Allowed"|"Disabled"
typealias StudioWebPortal = "ENABLED"|"DISABLED"
typealias TagPropagation = "ENABLED"|"DISABLED"
typealias AutoMountHomeEFS = "Enabled"|"Disabled"

@aws.SubResourceHint
open class AppLifecycleManagement extends formae.SubResource {
    idleSettings: IdleSettings?
}


@aws.SubResourceHint
open class CodeEditorAppSettings extends formae.SubResource {
    appLifecycleManagement: AppLifecycleManagement?
    customImages: Listing<CustomImage>?
    defaultResourceSpec: ResourceSpec?
    lifecycleConfigArns: Listing<String|formae.Resolvable>?
}

@aws.SubResourceHint
open class CodeRepository extends formae.SubResource {
    repositoryUrl: String(matches(Regex(#"^https://([.\-_a-zA-Z0-9]+/?){3,1016}$"#)))
}

@aws.SubResourceHint
open class CustomFileSystemConfig extends formae.SubResource {
    efsFileSystemConfig: EFSFileSystemConfig?
    fSxLustreFileSystemConfig: FSxLustreFileSystemConfig?
}

@aws.SubResourceHint
open class CustomImage extends formae.SubResource {
    appImageConfigName: String(matches(Regex(#"^[a-zA-Z0-9](-*[a-zA-Z0-9]){0,62}"#)))
    imageName: String(matches(Regex(#"^[a-zA-Z0-9]([-.]?[a-zA-Z0-9]){0,62}$"#)))
    imageVersionNumber: Int?
}

@aws.SubResourceHint
open class CustomPosixUserConfig extends formae.SubResource {
    gid: Int
    uid: Int
}

@aws.SubResourceHint
open class DefaultEbsStorageSettings extends formae.SubResource {
    defaultEbsVolumeSizeInGb: Int
    maximumEbsVolumeSizeInGb: Int
}

@aws.SubResourceHint
open class DefaultSpaceSettings extends formae.SubResource {
    customFileSystemConfigs: Listing<CustomFileSystemConfig>?
    customPosixUserConfig: CustomPosixUserConfig?
    executionRole: String(matches(Regex(#"^arn:aws[a-z\-]*:iam::\d{12}:role/?[a-zA-Z_0-9+=,.@\-_/]+$"#)))|formae.Resolvable
    jupyterLabAppSettings: JupyterLabAppSettings?
    jupyterServerAppSettings: JupyterServerAppSettings?
    kernelGatewayAppSettings: KernelGatewayAppSettings?
    securityGroups: (Listing<String|formae.Resolvable>)?
    spaceStorageSettings: SpaceStorageSettings?
}

@aws.SubResourceHint
open class SpaceStorageSettings extends formae.SubResource {
    defaultEbsStorageSettings: DefaultEbsStorageSettings?
}

@aws.SubResourceHint
open class DockerSettings extends formae.SubResource {
    enableDockerAccess: DockerSettingsEnableDockerAccess?
    vpcOnlyTrustedAccounts: Listing<String>?
}


@aws.SubResourceHint
open class DomainSettings extends formae.SubResource {
    dockerSettings: DockerSettings?
    executionRoleIdentityConfig: ExecutionRoleIdentityConfig?
    rStudioServerProDomainSettings: RStudioServerProDomainSettings?
    securityGroupIds: (Listing<String|formae.Resolvable>)?
}

@aws.SubResourceHint
open class EFSFileSystemConfig extends formae.SubResource {
    fileSystemId: String(matches(Regex(#"^(fs-[0-9a-f]{8,})$"#)))|formae.Resolvable
    fileSystemPath: (String(matches(Regex(#"^\/\S*$"#))))?
}

@aws.SubResourceHint
open class FSxLustreFileSystemConfig extends formae.SubResource {
    fileSystemId: String(matches(Regex(#"^(fs-[0-9a-f]{8,})$"#)))|formae.Resolvable
    fileSystemPath: (String(matches(Regex(#"^\/\S*$"#))))?
}

@aws.SubResourceHint
open class IdleSettings extends formae.SubResource {
    idleTimeoutInMinutes: Int?
    lifecycleManagement: String?
    maxIdleTimeoutInMinutes: Int?
    minIdleTimeoutInMinutes: Int?
}

@aws.SubResourceHint
open class JupyterLabAppSettings extends formae.SubResource {
    appLifecycleManagement: AppLifecycleManagement?
    codeRepositories: Listing<CodeRepository>?
    customImages: Listing<CustomImage>?
    defaultResourceSpec: ResourceSpec?
    lifecycleConfigArns: Listing<String|formae.Resolvable>?
}

@aws.SubResourceHint
open class JupyterServerAppSettings extends formae.SubResource {
    defaultResourceSpec: ResourceSpec?
    lifecycleConfigArns: Listing<String|formae.Resolvable>?
}

@aws.SubResourceHint
open class KernelGatewayAppSettings extends formae.SubResource {
    customImages: Listing<CustomImage>?
    defaultResourceSpec: ResourceSpec?
    lifecycleConfigArns: Listing<String|formae.Resolvable>?
}
@aws.SubResourceHint
open class RSessionAppSettings extends formae.SubResource {
    customImages: Listing<CustomImage>?
    defaultResourceSpec: ResourceSpec?
}

@aws.SubResourceHint
open class RStudioServerProAppSettings extends formae.SubResource {
    accessStatus: RStudioServerProAppSettingsAccessStatus?
    userGroup: RStudioServerProAppSettingsUserGroup?
}

@aws.SubResourceHint
open class RStudioServerProDomainSettings extends formae.SubResource {
    defaultResourceSpec: ResourceSpec?
    domainExecutionRoleArn: String(matches(Regex(#"^arn:aws[a-z\-]*:iam::\d{12}:role/?[a-zA-Z_0-9+=,.@\-_/]+$"#)))|formae.Resolvable
    rStudioConnectUrl: (String(matches(Regex(#"^(https:|http:|www\.)\S*"#))))?
    rStudioPackageManagerUrl: (String(matches(Regex(#"^(https:|http:|www\.)\S*"#))))?
}

@aws.SubResourceHint
open class ResourceSpec extends formae.SubResource {
    instanceType: InstanceType?
    lifecycleConfigArn: (String(matches(Regex(#"arn:aws[a-z\-]*:sagemaker:[a-z0-9\-]*:[0-9]{12}:studio-lifecycle-config/.*"#)))|formae.Resolvable)?
    sageMakerImageArn: (String(matches(Regex(#"^arn:aws(-[\w]+)*:sagemaker:.+:[0-9]{12}:image/[a-z0-9]([-.]?[a-z0-9])*$"#)))|formae.Resolvable)?
    sageMakerImageVersionArn: (String(matches(Regex(#"^arn:aws(-[\w]+)*:sagemaker:.+:[0-9]{12}:image-version/[a-z0-9]([-.]?[a-z0-9])*/[0-9]+$"#)))|formae.Resolvable)?
}


@aws.SubResourceHint
open class SharingSettings extends formae.SubResource {
    notebookOutputOption: SharingSettingsNotebookOutputOption?
    s3KmsKeyId: (String(matches(Regex(#".*"#)))|formae.Resolvable)?
    s3OutputPath: (String(matches(Regex(#"^(https|s3)://([^/]+)/?(.*)$"#))))?
}

@aws.SubResourceHint
open class StudioWebPortalSettings extends formae.SubResource {
    hiddenAppTypes: Listing<String>?
    hiddenMlTools: Listing<String>?
}

@aws.SubResourceHint
open class DefaultUserSettings extends formae.SubResource {
    codeEditorAppSettings: CodeEditorAppSettings?
    customFileSystemConfigs: Listing<CustomFileSystemConfig>?
    customPosixUserConfig: CustomPosixUserConfig?
    defaultLandingUri: String?
    executionRole: String(matches(Regex(#"^arn:aws[a-z\-]*:iam::\d{12}:role/?[a-zA-Z_0-9+=,.@\-_/]+$"#)))|formae.Resolvable
    jupyterLabAppSettings: JupyterLabAppSettings?
    jupyterServerAppSettings: JupyterServerAppSettings?
    kernelGatewayAppSettings: KernelGatewayAppSettings?
    rSessionAppSettings: RSessionAppSettings?
    rStudioServerProAppSettings: RStudioServerProAppSettings?
    securityGroups: (Listing<String|formae.Resolvable>)?
    sharingSettings: SharingSettings?
    spaceStorageSettings: SpaceStorageSettings?
    studioWebPortal: StudioWebPortal?
    studioWebPortalSettings: StudioWebPortalSettings?
    autoMountHomeEFS: AutoMountHomeEFS?
}

open class DomainResolvable extends formae.Resolvable {
    hidden type = module.type

    hidden domainArn: DomainResolvable = (this) {
        property = "DomainArn"
    }

    hidden domainId: DomainResolvable = (this) {
        property = "DomainId"
    }

    hidden homeEfsFileSystemId: DomainResolvable = (this) {
        property = "HomeEfsFileSystemId"
    }

    hidden securityGroupIdForDomainBoundary: DomainResolvable = (this) {
        property = "SecurityGroupIdForDomainBoundary"
    }

    hidden singleSignOnApplicationArn: DomainResolvable = (this) {
        property = "SingleSignOnApplicationArn"
    }

    hidden singleSignOnManagedApplicationInstanceId: DomainResolvable = (this) {
        property = "SingleSignOnManagedApplicationInstanceId"
    }

    hidden url: DomainResolvable = (this) {
        property = "Url"
    }
}


@aws.ResourceHint {
    type = module.type
    identifier = "Ref"
    docComment = "This resource creates an EFS system - AutoHomeEFS - which will need to be manually removed prior to successfully destroying the domain."
}
open class Domain extends formae.Resource {

    @aws.FieldHint
    appNetworkAccessType: AppNetworkAccessType?

    @aws.FieldHint
    appSecurityGroupManagement: AppSecurityGroupManagement?

    @aws.FieldHint{createOnly = true}
    authMode: AuthMode

    @aws.FieldHint
    defaultSpaceSettings: DefaultSpaceSettings?

    @aws.FieldHint
    defaultUserSettings: DefaultUserSettings

    @aws.FieldHint{createOnly = true}
    domainName: String(matches(Regex(#"^[a-zA-Z0-9](-*[a-zA-Z0-9]){0,62}"#)))

    @aws.FieldHint
    domainSettings: DomainSettings?

    @aws.FieldHint{createOnly = true}
    kmsKeyId: (String(matches(Regex(#".*"#)))|formae.Resolvable)?

    @aws.FieldHint
    subnetIds: Listing<String|formae.Resolvable>

    @aws.FieldHint
    tagPropagation: TagPropagation?

    @aws.FieldHint{
        createOnly = true
        writeOnly = true
    }
    tags: Listing<aws.Tag>?

    @aws.FieldHint{createOnly = true}
    vpcId: String(matches(Regex(#"[-0-9a-zA-Z]+"#)))|formae.Resolvable

    hidden parent = this

    hidden res: DomainResolvable = new {
        label = parent.label
        stack = parent.stack?.label
    }
}