/*
 * Â© 2025 Platform Engineering Labs Inc.
 *
 * SPDX-License-Identifier: FSL-1.1-ALv2
 */

amends "@formae/forma.pkl"
import "@formae/formae.pkl"
import "@aws/aws.pkl"
import "@aws/s3/bucket.pkl"

properties {
    name = new formae.Prop {
        flag = "name"
        default = "pel-s3-demo"
    }
    bucketSuffix = new formae.Prop {
        flag = "bucketSuffix"
        default = "-unique-bucket-id"
    }
}

forma {
    local stack = new formae.Stack {
        label = "pel-s3-simple-bucket"
        description = "Stack for a simple S3 Bucket"
    }
    stack

    local target = new formae.Target {
        label = "default-aws-target"
        config = new aws.Config {
            region = "us-west-2"
        }
    }
    target

    new bucket.Bucket {
        label = "simple-demo-bucket"
        bucketName = properties.name.value + properties.bucketSuffix.value
        versioningConfiguration = new bucket.VersioningConfiguration {
            status = "Enabled"
        }
        tags {
            new {
                key = "Name"
                value = properties.name.value + "-bucket"
            }
            new {
                key = "Project"
                value = "FormaeDemo"
            }
            new {
                key = "Environment"
                value = "Development"
            }
        }
        publicAccessBlockConfiguration = new bucket.PublicAccessBlockConfiguration {
            blockPublicAcls = true
            blockPublicPolicy = true
            ignorePublicAcls = true
            restrictPublicBuckets = true
        }
        bucketEncryption = new bucket.BucketEncryption {
            serverSideEncryptionConfiguration {
                new bucket.ServerSideEncryptionRule {
                    serverSideEncryptionByDefault = new bucket.BucketServerSideEncryptionByDefault {
                        sseAlgorithm = "AES256"
                    }
                }
            }
        }
    }
}